<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§æ¨¡å‹å¯¹é½æŠ€æœ¯æ¼”è¿›å›¾è°± (Data Driven)</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* --- æ ·å¼å±‚ï¼šæš—è‰²/æµ…è‰²åŒä¸»é¢˜ --- */
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: background-color 0.25s ease, color 0.25s ease;
        }
        h1 { color: #58a6ff; margin-bottom: 5px; font-size: 24px; transition: color 0.25s ease; }
        .subtitle { font-size: 14px; color: #8b949e; margin-bottom: 20px; text-align: center; transition: color 0.25s ease; }

        .theme-toggle {
            margin-bottom: 10px;
        }
        .theme-toggle button {
            padding: 4px 10px;
            font-size: 12px;
            border-radius: 999px;
            border: 1px solid #30363d;
            background: #161b22;
            color: #c9d1d9;
            cursor: pointer;
        }
        .theme-toggle button:hover {
            background: #21262d;
        }
        
        .chart-wrapper {
            position: relative;
            width: 100%;
            max-width: 1200px;
        }

        #chart-container {
            width: 100%;
            height: 650px;
            background: #161b22;
            border-radius: 12px;
            border: 1px solid #30363d;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }

        #loading-msg {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: #58a6ff;
            font-size: 18px;
            display: none; /* é»˜è®¤éšè—ï¼ŒJSæ§åˆ¶æ˜¾ç¤º */
            z-index: 10;
            pointer-events: none;
        }

        .legend-info {
            margin-top: 20px;
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #8b949e;
            background: #161b22;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #30363d;
        }
        .legend-info span { font-weight: bold; margin-right: 5px; color: #fff; }

        /* æ•°æ®ç»Ÿè®¡ä¿¡æ¯ */
        #data-stats {
            margin-top: 8px;
            font-size: 13px;
            color: #8b949e;
            text-align: center;
        }

        /* æµ…è‰²ä¸»é¢˜è¦†ç›– */
        body.light-theme {
            background-color: #f5f5f5;
            color: #24292f;
        }
        body.light-theme h1 {
            color: #0969da;
        }
        body.light-theme .subtitle {
            color: #57606a;
        }
        body.light-theme #chart-container {
            background: #ffffff;
            border-color: #d0d7de;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        body.light-theme .legend-info {
            background: #ffffff;
            border-color: #d0d7de;
            color: #57606a;
        }
        body.light-theme .legend-info span {
            color: #24292f;
        }
        body.light-theme #data-stats {
            color: #57606a;
        }
        body.light-theme #loading-msg {
            color: #0969da;
        }
        body.light-theme .theme-toggle button {
            background: #ffffff;
            border-color: #d0d7de;
            color: #24292f;
        }
        body.light-theme .theme-toggle button:hover {
            background: #f3f4f6;
        }
    </style>
</head>
<body>

    <!-- æ ‡é¢˜åŒº -->
    <h1>å¤§æ¨¡å‹å¯¹é½æŠ€æœ¯æ¼”è¿›å›¾è°±</h1>
    <div class="subtitle">
        åŸºäºç§‘ç ”ä»·å€¼ç­›é€‰çš„æ ¸å¿ƒæ ·æœ¬ç‚¹å±•ç¤º<br>
        Xè½´ï¼šæ—¶é—´ | Yè½´ï¼šæ–¹æ³•æ•ˆç‡ä¸å½±å“åŠ›
    </div>

    <!-- ä¸»é¢˜åˆ‡æ¢ -->
    <div class="theme-toggle">
        <button id="theme-toggle-btn">åˆ‡æ¢ä¸ºæµ…è‰²èƒŒæ™¯</button>
    </div>

    <!-- å›¾è¡¨å®¹å™¨ -->
    <div class="chart-wrapper">
        <div id="chart-container"></div>
        <div id="loading-msg">æ­£åœ¨åŠ è½½æ•°æ®...</div>
    </div>

    <!-- é™æ€è¾…åŠ©å›¾ä¾‹ -->
    <div class="legend-info">
        <div><span>â—</span> é€šç”¨å¯¹è¯ (General Chat)</div>
        <div><span>â–²</span> æ•°å­¦/æ¨ç† (Reasoning)</div>
    </div>

    <!-- æ•°æ®ç»Ÿè®¡ -->
    <div id="data-stats"></div>

    <script>
        // --- é…ç½®å¸¸é‡ ---
        const CONFIG = {
            // å¸¦æ—¶é—´æˆ³å‚æ•°ï¼Œé¿å…æµè§ˆå™¨ç¼“å­˜ data.json
            jsonUrl: `./data.json?v=${Date.now()}`,
            colors: {
                'RLHF (ä¼ ç»Ÿæ´¾)': '#e3b341',                 // é»„è‰² - PPO, GPT-4, Llama 2
                'RLAIF (AIåé¦ˆ)': '#58a6ff',                // è“è‰² - Claude ç³»åˆ—, Starling
                'Reasoning / RLVF': '#f85149',              // çº¢è‰² - DeepSeek R1, o1, Math models
                'Direct Alignment (å»RLåŒ–)': '#3fb950',     // ç»¿è‰² - DPO, Llama 3, Qwen
                'SFT / Distillation': '#a371f7',            // ç´«è‰² - Alpaca, Vicuna, Phi
                'PRM (è¿‡ç¨‹ç›‘ç£)': '#ffb6c1'                 // ç²‰è‰² - Math Shepherd, InternLM2-Math, Qwen2-Math
            },
            shapes: {
                'general': 'circle',
                'reasoning': 'triangle'
            }
        };

        // --- ä¸»é¢˜é…ç½® ---
        const THEME_STYLES = {
            dark: {
                text: '#c9d1d9',
                muted: '#8b949e',
                border: '#30363d',
                grid: '#30363d',
                tooltipBg: 'rgba(22, 27, 34, 0.95)'
            },
            light: {
                text: '#24292f',
                muted: '#57606a',
                border: '#d0d7de',
                grid: '#d0d7de',
                tooltipBg: 'rgba(255, 255, 255, 0.98)'
            }
        };

        let currentTheme = 'dark';
        let lastOption = null;

        // --- åˆå§‹åŒ– ECharts ---
        const chartDom = document.getElementById('chart-container');
        const loadingMsg = document.getElementById('loading-msg'); // åœ¨ ECharts åˆå§‹åŒ–å‰è·å–å¼•ç”¨
        const dataStats = document.getElementById('data-stats');
        const themeToggleBtn = document.getElementById('theme-toggle-btn');
        const myChart = echarts.init(chartDom, 'dark'); // ECharts åˆå§‹åŒ–ä¼šæ¸…ç©ºå®¹å™¨å†…å®¹

        // --- æ ¸å¿ƒé€»è¾‘å‡½æ•° ---
        async function initChart() {
            try {
                // 1. æ˜¾ç¤º Loading
                if (loadingMsg) {
                    loadingMsg.style.display = 'block';
                }

                // 2. Fetch åŠ è½½æ•°æ®
                const response = await fetch(CONFIG.jsonUrl);
                if (!response.ok) throw new Error('ç½‘ç»œå“åº”é”™è¯¯');
                const rawData = await response.json();

                // 3. æ•°æ®é¢„å¤„ç† (Data Processing)
                // æˆ‘ä»¬éœ€è¦æŠŠæ‰å¹³çš„ JSON æ•°ç»„ï¼ŒæŒ‰ cluster åˆ†ç»„ï¼Œå˜æˆ ECharts éœ€è¦çš„ Series æ ¼å¼
                const seriesGroups = {};
                
                // åˆå§‹åŒ–åˆ†ç»„
                Object.keys(CONFIG.colors).forEach(groupName => {
                    seriesGroups[groupName] = [];
                });

                // æ•°æ®ç»Ÿè®¡
                const totalCount = rawData.length;
                let usedCount = 0;
                let skippedCount = 0;

                // éå†æ•°æ®å¹¶åˆ†ç±»
                rawData.forEach(item => {
                    if (!seriesGroups[item.cluster]) {
                        seriesGroups[item.cluster] = []; // é˜²æ­¢ JSON é‡Œæœ‰æœªå®šä¹‰çš„æ–°åˆ†ç±»
                    }

                    const dateValue = item.date;
                    const valueNum = typeof item.value === 'number' ? item.value : Number(item.value);

                    // åŸºæœ¬æ ¡éªŒï¼šæ—¥æœŸå’Œå€¼å¿…é¡»æœ‰æ•ˆ
                    if (!dateValue || Number.isNaN(new Date(dateValue).getTime()) || Number.isNaN(valueNum)) {
                        skippedCount++;
                        console.warn('è·³è¿‡æ— æ•ˆæ•°æ®ç‚¹:', item);
                        return;
                    }

                    seriesGroups[item.cluster].push({
                        name: item.name,
                        value: [dateValue, valueNum], // X, Y åæ ‡ï¼ˆX ä¸ºæ—¥æœŸå­—ç¬¦ä¸²ï¼‰
                        symbol: CONFIG.shapes[item.domain] || 'circle', // å½¢çŠ¶æ˜ å°„
                        symbolSize: item.domain === 'reasoning' ? 18 : 14, // ä¸‰è§’å½¢ç¨å¾®å¤§ä¸€ç‚¹æ‰è§†è§‰å¹³è¡¡
                        // å°†æ‰€æœ‰è¯¦ç»†å­—æ®µå­˜å…¥ customDataï¼Œä¾› Tooltip ä½¿ç”¨
                        customData: item 
                    });

                    usedCount++;
                });

                console.info(
                    `å¯¹é½å›¾è°±: ä» JSON è¯»å– ${totalCount} æ¡è®°å½•, æˆåŠŸç»˜åˆ¶ ${usedCount} æ¡, è·³è¿‡ ${skippedCount} æ¡ã€‚`
                );

                if (dataStats) {
                    dataStats.textContent = `å½“å‰å±•ç¤º ${usedCount} / ${totalCount} ä¸ªæ•°æ®ç‚¹`;
                }

                // 4. æ„å»º Series é…ç½®
                const seriesList = Object.keys(seriesGroups).map(groupName => ({
                    name: groupName,
                    type: 'scatter',
                    itemStyle: { 
                        color: CONFIG.colors[groupName] || '#888' // æ‰¾ä¸åˆ°é¢œè‰²å°±ç”¨ç°è‰²
                    },
                    data: seriesGroups[groupName],
                    markPoint: {
                        data: [{type: 'max', name: 'Max'}]
                    }
                }));

                // 5. è®¾ç½®å›¾è¡¨ Option
                const theme = THEME_STYLES[currentTheme];

                const option = {
                    backgroundColor: 'transparent',
                    tooltip: {
                        trigger: 'item',
                        backgroundColor: theme.tooltipBg,
                        borderColor: theme.border,
                        textStyle: { color: theme.text },
                        padding: 15,
                        formatter: function (params) {
                            const info = params.data.customData;
                            if (!info) return '';
                            
                            // åŠ¨æ€ç”Ÿæˆçš„ HTML æ¨¡æ¿
                            return `
                                <div style="font-size: 16px; font-weight: bold; color: ${params.color}; margin-bottom: 5px;">
                                    ${info.name}
                                </div>
                                <div style="font-size: 12px; color: #8b949e; margin-bottom: 10px;">
                                    ğŸ“… ${info.date} &nbsp;|&nbsp; ğŸ·ï¸ ${info.cluster}
                                </div>
                                <div style="border-top: 1px solid #30363d; padding-top: 8px; font-size: 13px;">
                                    <b style="color:#fff">ğŸ“Œ æ ¸å¿ƒæ¡ä»¶ (Representative Conditions):</b><br>
                                    <span style="color: #d2a8ff;">${info.conditions}</span>
                                </div>
                                <div style="margin-top: 8px; font-size: 13px;">
                                    <b style="color:#fff">ğŸ“Š å®éªŒæ•ˆæœ (Experimental Results):</b><br>
                                    <span style="color: #7ee787;">${info.result}</span>
                                </div>
                            `;
                        }
                    },
                    // å·¥å…·æ ï¼šæ”¯æŒåŒºåŸŸç¼©æ”¾ã€è¿˜åŸç­‰
                    toolbox: {
                        right: 20,
                        top: 15,
                        feature: {
                            dataZoom: { yAxisIndex: 'none' }, // åªæ˜¾ç¤º X è½´ç¼©æ”¾æŒ‰é’®
                            restore: {},
                            saveAsImage: {}
                        },
                        iconStyle: {
                            borderColor: theme.muted
                        }
                    },
                    legend: {
                        data: Object.keys(seriesGroups), // è‡ªåŠ¨ç”Ÿæˆå›¾ä¾‹
                        bottom: 10,
                        textStyle: { color: theme.muted }
                    },
                    grid: { top: '10%', left: '5%', right: '10%', bottom: '15%', containLabel: true },
                    // æ”¯æŒé¼ æ ‡æ»šè½®ç¼©æ”¾ / æ‹–æ‹½å¹³ç§»
                    dataZoom: [
                        {
                            type: 'inside',
                            xAxisIndex: 0,
                            filterMode: 'none'
                        },
                        {
                            type: 'inside',
                            yAxisIndex: 0,
                            filterMode: 'none'
                        }
                    ],
                    xAxis: {
                        type: 'time',
                        name: 'æ—¶é—´ (Time)',
                        nameTextStyle: { color: theme.muted },
                        axisLabel: { 
                            color: theme.muted, 
                            formatter: function(value) {
                                const date = new Date(value);
                                return date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
                            }
                        },
                        splitLine: { show: true, lineStyle: { color: theme.grid, type: 'dashed' } }
                    },
                    yAxis: {
                        type: 'value',
                        name: 'ç§‘ç ”ä»·å€¼ / æ•ˆç‡ (Value)',
                        nameTextStyle: { color: theme.muted },
                        axisLabel: { show: false }, // éšè—å…·ä½“æ•°å€¼ï¼Œå¼ºè°ƒç›¸å¯¹æ€§
                        splitLine: { show: true, lineStyle: { color: theme.grid, opacity: 0.3 } },
                        min: 2, max: 11
                    },
                    series: seriesList
                };

                // æ¸²æŸ“
                lastOption = option;
                myChart.setOption(option);
                if (loadingMsg) {
                    loadingMsg.style.display = 'none';
                }

            } catch (error) {
                console.error('æ•°æ®åŠ è½½é”™è¯¯:', error);
                let errorMsg = 'æ•°æ®åŠ è½½å¤±è´¥: ' + error.message;
                if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                    errorMsg += '<br><br>æç¤ºï¼šè¯·ä½¿ç”¨æœ¬åœ°æœåŠ¡å™¨è¿è¡Œï¼ˆå¦‚ Python: python -m http.server æˆ– VS Code Live Serverï¼‰';
                }
                if (loadingMsg) {
                    loadingMsg.innerHTML = errorMsg;
                    loadingMsg.style.color = '#f85149';
                    loadingMsg.style.display = 'block';
                }
            }
        }

        // --- ä¸»é¢˜åˆ‡æ¢é€»è¾‘ ---
        function applyThemeToChart() {
            if (!lastOption) return;
            const theme = THEME_STYLES[currentTheme];
            myChart.setOption({
                tooltip: {
                    backgroundColor: theme.tooltipBg,
                    borderColor: theme.border,
                    textStyle: { color: theme.text }
                },
                legend: {
                    textStyle: { color: theme.muted }
                },
                toolbox: {
                    iconStyle: { borderColor: theme.muted }
                },
                xAxis: {
                    nameTextStyle: { color: theme.muted },
                    axisLabel: { color: theme.muted },
                    splitLine: { lineStyle: { color: theme.grid, type: 'dashed' } }
                },
                yAxis: {
                    nameTextStyle: { color: theme.muted },
                    splitLine: { lineStyle: { color: theme.grid, opacity: 0.3 } }
                }
            });
        }

        if (themeToggleBtn) {
            themeToggleBtn.addEventListener('click', () => {
                currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.classList.toggle('light-theme', currentTheme === 'light');
                themeToggleBtn.textContent = currentTheme === 'dark' ? 'åˆ‡æ¢ä¸ºæµ…è‰²èƒŒæ™¯' : 'åˆ‡æ¢ä¸ºå¤œé—´èƒŒæ™¯';
                applyThemeToChart();
            });
        }

        // --- å¯åŠ¨ ---
        initChart();

        // å“åº”çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => myChart.resize());

    </script>
</body>
</html>